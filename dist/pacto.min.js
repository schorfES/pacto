!function(t,e){if("function"==typeof define&&define.amd)define("pacto",["exports"],e);else if("undefined"!=typeof exports)e(exports);else{var n={};e(n),t.pacto=n}}(this,function(t){"use strict";function r(t){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function i(t,e){return!e||"object"!==r(e)&&"function"!=typeof e?c(t):e}function c(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function s(t,e,n){return(s="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,n){var r=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=a(t)););return t}(t,e);if(r){var o=Object.getOwnPropertyDescriptor(r,e);return o.get?o.get.call(n):o.value}})(t,e,n||t)}function a(t){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function e(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&n(t,e)}function n(t,e){return(n=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function f(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function l(t,e,n){return e&&o(t.prototype,e),n&&o(t,n),t}Object.defineProperty(t,"__esModule",{value:!0}),t.View=t.InitializeLazy=t.Initialize=t.EventEmitter=t.Context=void 0;var u=new WeakMap,h=function(){function t(){f(this,t),u.set(this,{})}return l(t,[{key:"on",value:function(t,e){var n=u.get(this);return n[t]=n[t]||[],n[t].push(e),this}},{key:"off",value:function(t,e){var n=u.get(this);return n[t]&&(n[t]=e?n[t].filter(function(t){return t!==e}):[]),this}},{key:"trigger",value:function(e){var n=this,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,t=u.get(this);return t[e]&&t[e].forEach(function(t){return t.call(null,{sender:n,type:e,data:r})}),this}}]),t}();t.EventEmitter=h;var v=new WeakMap,y=function(){function n(t){f(this,n);var e={context:t,register:{}};v.set(this,e)}return l(n,[{key:"add",value:function(t,e){return v.get(this).register[t]=e,this}},{key:"remove",value:function(t){var e=v.get(this).register;return e[t]=void 0,delete e[t],this}},{key:"get",value:function(t){return v.get(this).register[t]}},{key:"has",value:function(t){return!!this.get(t)}}]),n}(),p=function(t){function u(r){var t;f(this,u),t=i(this,a(u).call(this,r));var e=v.get(c(t)),o=e.register;return e.onAction=function(n){var t=n.type,e=o[t];e&&[].concat(e).forEach(function(t){var e=new t;e.context=r,e.event=n,e.run()})},t}return e(u,y),l(u,[{key:"add",value:function(t,e){var n=v.get(this),r=n.context,o=n.onAction,i=this.get(t);return i||r.on(t,o),e=(i||[]).concat(e),s(a(u.prototype),"add",this).call(this,t,e)}},{key:"remove",value:function(t,e){var n=this.get(t);if(n&&n.length){if(!e)return s(a(u.prototype),"remove",this).call(this,t);if(e instanceof Array||(e=[e]),e.forEach(function(t){for(var e=n.indexOf(t);-1<e;)n.splice(e,1),e=n.indexOf(t)}),0===n.length)return s(a(u.prototype),"remove",this).call(this,t)}return this}}]),u}(),g=function(t){function r(){var t,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;f(this,r),t=i(this,a(r).call(this));var n={actions:new p(c(t)),values:new y(c(t)),options:e};return e&&e.history&&(n.history=[]),v.set(c(t),n),t}return e(r,h),l(r,[{key:"trigger",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null,n=this.history;return n&&n.push({type:t,data:e}),s(a(r.prototype),"trigger",this).call(this,t,e)}},{key:"flushHistory",value:function(){var t=this.history;t&&t.splice(0,t.length)}},{key:"actions",get:function(){return v.get(this).actions}},{key:"values",get:function(){return v.get(this).values}},{key:"history",get:function(){return v.get(this).history||null}}]),r}();function d(t){return"boolean"==typeof t&&!t}t.Context=g;var b=function(){function t(){f(this,t)}return l(t,[{key:"run",value:function(){var t,o=this,i=function(t){var e=t.settings;if(!e||"object"!==r(e))throw new Error("Define settings object");if(!e.view)throw new Error("Define a view");if(!e.selector)throw new Error("Define a selector");if(!e.namespace)throw new Error("Define a namespace");return e}(this),u=this.context,e=this.event.data,c=u.values.get(i.namespace)||[],n=e&&e.root?e.root:document.body;d(this.beforeAll())||0!==(t=n.querySelectorAll(i.selector)).length&&(t.forEach(function(e,t){if(!c.some(function(t){return t.el==e})){var n=function(o){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{},e=Object.keys(i);"function"==typeof Object.getOwnPropertySymbols&&(e=e.concat(Object.getOwnPropertySymbols(i).filter(function(t){return Object.getOwnPropertyDescriptor(i,t).enumerable}))),e.forEach(function(t){var e,n,r;e=o,r=i[n=t],n in e?Object.defineProperty(e,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[n]=r})}return o}({el:e,context:u},i.params),r=null;d(o.beforeEach(n,e,t))||((r=new i.view(n)).render(),d(o.afterEach(r,e,t))||c.push(r))}}),0<c.length&&u.values.add(i.namespace,c),this.afterAll(c))}},{key:"beforeAll",value:function(){}},{key:"beforeEach",value:function(){}},{key:"afterEach",value:function(){}},{key:"afterAll",value:function(){}},{key:"settings",get:function(){return null}}]),t}();t.Initialize=b;var w=function(){function t(){f(this,t),this._onIntersect=this._onIntersect.bind(this)}return l(t,[{key:"run",value:function(){var t=function(t){var e=t.settings;if(!e||"object"!==r(e))throw new Error("Define settings object");if(!e.selector)throw new Error("Define a selector");return e}(this);this._lookup(t.selector)}},{key:"_lookup",value:function(t){var e=this,n=this.event.data,r=(n&&n.root?n.root:document.body).querySelectorAll(t);0!==r.length&&("complete"===document.readyState?this._setup(r):window.addEventListener("load",function(){return e._setup(r)},{once:!0}))}},{key:"_setup",value:function(t){window.IntersectionObserver?this._observe(t):this._fetch()}},{key:"_observe",value:function(t){var e=this;this._observer=new window.IntersectionObserver(this._onIntersect,this.observerSettings),t.forEach(function(t){return e._observer.observe(t)})}},{key:"_disconnect",value:function(){this._observer.disconnect(),this._observer=null}},{key:"_fetch",value:function(){var n=this,r=this.event;this.import.then(function(t){var e=t.Action||t.default;if(!e)throw new Error("Module must export Action or default");if("function"!=typeof e.prototype.run)throw new Error("Module must be an Action");n.context.actions.add(r.type,e).remove(r.type,n.constructor),n._execute(e)}).catch(function(t){throw n.context.trigger(n.event.type+":error",{error:t}),t})}},{key:"_execute",value:function(t){var e=new t;e.context=this.context,e.event=this.event,e.run()}},{key:"_onIntersect",value:function(t){t.some(function(t){return t.isIntersecting})&&(this._disconnect(),this._fetch())}},{key:"settings",get:function(){return null}},{key:"import",get:function(){return null}},{key:"observerSettings",get:function(){return{rootMargin:"0px",threshold:[0,.5,1]}}}]),t}();t.InitializeLazy=w;var k=function(t){function n(t){var e;return f(this,n),(e=i(this,a(n).call(this))).options=t,e.context=t.context,e.el=t.el,e}return e(n,h),l(n,[{key:"render",value:function(){return this}},{key:"destroy",value:function(){return this.options=null,this.context=null,this.el=null,this}}]),n}();t.View=k});